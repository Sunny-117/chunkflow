# 实现计划: ChunkFlow Upload SDK

## 概述

本实现计划将 ChunkFlow Upload SDK 的设计转化为一系列可执行的编码任务。采用增量式开发方式，从底层协议和工具开始，逐步构建核心功能、框架适配层、UI 组件，最后完成服务端实现。每个任务都建立在前面任务的基础上，确保代码的连贯性和可测试性。

## 任务

- [x] 1. 项目初始化和基础架构
  - 创建 Monorepo 项目结构（pnpm workspace + Turbo）
  - 配置 TypeScript、tsdown 构建工具
  - 配置 oxlint、oxfmt、lint-staged
  - 配置 Vitest 测试框架
  - 创建所有包的基础目录结构
  - _需求: 14.1, 14.2, 14.3, 15.1, 15.2, 15.3, 15.4_

- [~] 2. Protocol 层实现
  - [x] 2.1 定义核心类型和接口
    - 创建 `@chunkflow/protocol` 包
    - 定义 FileInfo、ChunkInfo、UploadToken 等核心类型
    - 定义 UploadStatus 枚举
    - 定义 API 请求/响应接口（CreateFile, VerifyHash, UploadChunk, MergeFile）
    - 定义 RequestAdapter 接口
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_
  - [x] 2.2 编写 Protocol 层单元测试
    - 测试类型定义的完整性
    - 测试接口的类型安全性
    - _需求: 7.5_

- [~] 3. Shared 层实现
  - [x] 3.1 实现事件系统
    - 创建 `@chunkflow/shared` 包
    - 集成 mitt 库
    - 定义 UploadEvents 类型
    - 实现 createEventBus 工具函数
    - _需求: 6.1, 6.2, 9.1_
  - [x] 3.2 实现并发控制
    - 集成 p-limit 库
    - 实现 ConcurrencyController 类
    - 支持动态调整并发限制
    - _需求: 5.4, 9.2_
  - [x] 3.3 实现文件工具函数
    - 实现 sliceFile 函数
    - 实现 calculateFileHash 函数（使用 spark-md5）
    - 实现 calculateChunkHash 函数
    - 实现 formatFileSize、calculateSpeed、estimateRemainingTime 工具函数
    - _需求: 9.3_
  - [x] 3.4 实现 IndexedDB 存储
    - 实现 UploadStorage 类
    - 实现 init、saveRecord、getRecord、updateRecord、deleteRecord、getAllRecords 方法
    - 处理 IndexedDB 错误和降级
    - _需求: 4.1, 4.2, 9.3_
  - [x] 3.5 编写 Shared 层单元测试
    - 测试事件系统的发布订阅
    - 测试并发控制的队列管理
    - 测试文件工具函数的正确性
    - 测试 IndexedDB 存储的 CRUD 操作
    - _需求: 9.1, 9.2, 9.3_
  - [x]\* 3.6 编写 Shared 层属性测试
    - **属性 22**: 分片 Hash 唯一性
    - **验证需求**: 18.1

- [x] 4. Core 层 - 动态切片大小调整器
  - [x] 4.1 实现 ChunkSizeAdjuster 类
    - 创建 `@chunkflow/core` 包
    - 实现初始化逻辑
    - 实现 adjust 方法（类似 TCP 慢启动）
    - 实现 getCurrentSize 方法
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_
  - [x] 4.2 编写 ChunkSizeAdjuster 单元测试
    - 测试初始大小设置
    - 测试快速上传时增大分片
    - 测试慢速上传时减小分片
    - 测试边界值（最小/最大）
    - _需求: 2.1, 2.2, 2.3, 2.4_
  - [x]\* 4.3 编写 ChunkSizeAdjuster 属性测试
    - **属性 2**: 动态分片大小调整
    - **验证需求**: 2.2, 2.3, 2.4

- [~] 5. Core 层 - UploadTask 实现
  - [x] 5.1 实现 UploadTask 基础结构
    - 定义 UploadTaskOptions 和 UploadProgress 接口
    - 实现 UploadTask 类构造函数
    - 初始化状态、进度、事件总线等属性
    - _需求: 8.4, 8.5_
  - [x] 5.2 实现文件切分逻辑
    - 实现 createChunks 方法
    - 根据协商的分片大小切分文件
    - _需求: 2.1_
  - [x] 5.3 实现分片上传逻辑
    - 实现 start 方法（创建文件、切分、开始上传）
    - 实现 startUpload 方法（并发上传分片）
    - 实现 uploadChunkWithRetry 方法（带重试的分片上传）
    - 集成 ChunkSizeAdjuster 动态调整分片大小
    - _需求: 1.1, 1.2, 2.2, 5.1, 5.2, 5.3, 20.1, 20.2, 20.3, 20.5_
  - [x] 5.4 实现 Hash 计算与校验
    - 实现 calculateAndVerifyHash 方法
    - 使用 Web Worker 或 requestIdleCallback 计算 Hash
    - 实现秒传逻辑（文件已存在）
    - 实现部分秒传逻辑（跳过已存在的分片）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_
  - [x] 5.5 实现 Hash 计算与上传并行
    - 确保 Hash 计算和分片上传同时进行
    - 实现 Hash 完成后的秒传取消逻辑
    - 实现优先上传前几个分片的逻辑
    - _需求: 3.6, 17.1, 17.2, 17.3, 17.5_
  - [x] 5.6 实现进度跟踪和持久化
    - 实现 updateProgress 方法
    - 计算上传速度和剩余时间
    - 将进度写入 IndexedDB
    - 触发 progress 事件
    - _需求: 4.1, 6.3, 6.4_
  - [x] 5.7 实现暂停、恢复、取消功能
    - 实现 pause 方法
    - 实现 resume 方法（断点续传）
    - 实现 cancel 方法
    - 触发对应的生命周期事件
    - _需求: 4.3, 4.4, 6.3_
  - [x] 5.8 实现事件监听和状态查询
    - 实现 on 方法（事件订阅）
    - 实现 getStatus 方法
    - 实现 getProgress 方法
    - _需求: 6.1, 6.3, 6.4_
  - [x] 5.9 编写 UploadTask 单元测试
    - 测试文件切分逻辑
    - 测试分片上传流程
    - 测试重试机制
    - 测试暂停/恢复/取消
    - 测试事件触发
    - _需求: 1.1, 1.2, 3.1, 3.4, 3.5, 4.4, 6.3, 20.1_
  - [x]\* 5.10 编写 UploadTask 属性测试
    - **属性 1**: 文件大小决定上传策略
    - **属性 3**: Hash 计算触发
    - **属性 4**: 秒传机制
    - **属性 5**: 部分秒传
    - **属性 6**: Hash 计算与上传并行
    - **属性 7**: 断点续传持久化
    - **属性 8**: 断点续传恢复
    - **属性 10**: 生命周期事件触发
    - **属性 19**: 自动重试机制
    - **属性 20**: 重试耗尽处理
    - **属性 21**: 上传优先级
    - **验证需求**: 1.1, 1.2, 3.1, 3.3, 3.4, 3.5, 3.6, 4.1, 4.4, 6.3, 6.4, 17.1, 17.2, 17.3, 17.5, 20.1, 20.4, 20.5

- [x] 6. Checkpoint - 核心上传功能验证
  - 确保所有核心层测试通过（对于目前失败的测试case，如果因为环境没有对应API，需要提前报错。如果因为还没实现，就先skip。不合理或者重复的case可以清理下。耗时过长的单元测试重新设计下或者删掉，不要让整体测试运行耗时太长且有错误）
  - 手动测试文件上传、暂停、恢复、取消功能
  - 验证 Hash 计算和秒传功能

- [~] 7. Core 层 - UploadManager 和插件系统
  - [x] 7.1 实现 UploadManager 类
    - 定义 UploadManagerOptions 接口
    - 实现构造函数和初始化
    - 实现 createTask 方法
    - 实现 getTask、getAllTasks 方法
    - 实现 deleteTask 方法
    - _需求: 8.6_
  - [x] 7.2 实现未完成任务恢复
    - 实现 resumeUnfinishedTasks 方法
    - 从 IndexedDB 读取未完成任务
    - 自动恢复或提示用户
    - _需求: 4.2, 4.3_
  - [x] 7.3 实现插件系统
    - 定义 Plugin 接口
    - 实现 use 方法（注册插件）
    - 在任务生命周期中调用插件钩子
    - 实现示例插件（LoggerPlugin、StatisticsPlugin）
    - _需求: 6.5, 8.5_
  - [x] 7.4 编写 UploadManager 单元测试
    - 测试任务创建和管理
    - 测试任务恢复逻辑
    - 测试插件系统
    - _需求: 4.2, 4.3, 6.5, 8.6_
  - [x]\* 7.5 编写 UploadManager 属性测试
    - **属性 9**: 并发控制
    - **属性 11**: 状态机转换
    - **属性 12**: 队列管理
    - **验证需求**: 5.3, 8.4, 8.6

- [~] 8. Client 层 - React 适配
  - [x] 8.1 实现 UploadProvider 和 Context
    - 创建 `@chunkflow/upload-client-react` 包
    - 实现 UploadContext
    - 实现 UploadProvider 组件
    - 实现 useUploadManager Hook
    - _需求: 10.1, 10.3, 10.4_
  - [x] 8.2 实现 useUpload Hook
    - 定义 UseUploadOptions 和 UseUploadReturn 接口
    - 实现 upload、pause、resume、cancel 方法
    - 实现响应式状态管理（status、progress、error）
    - 集成生命周期回调
    - _需求: 10.1, 10.5_
  - [x] 8.3 实现 useUploadList Hook
    - 定义 UseUploadListReturn 接口
    - 实现 uploadFiles、pauseAll、resumeAll、cancelAll 方法
    - 实现 removeTask 方法
    - 实现响应式任务列表
    - _需求: 10.1, 10.5_
  - [x] 8.4 编写 React 适配层单元测试
    - 测试 UploadProvider 初始化和清理
    - 测试 useUpload Hook 的状态管理
    - 测试 useUploadList Hook 的任务管理
    - _需求: 10.1, 10.3, 10.4, 10.5_
  - [x]\* 8.5 编写 React 适配层属性测试
    - **属性 13**: 响应式状态更新
    - **验证需求**: 10.5

- [~] 9. Client 层 - Vue 适配
  - [x] 9.1 实现 Vue Plugin 和 Provide/Inject
    - 创建 `@chunkflow/upload-client-vue` 包
    - 实现 Vue Plugin
    - 实现 provide/inject 机制
    - _需求: 10.2, 10.3, 10.4_
  - [x] 9.2 实现 useUpload Composable
    - 使用 ref 和 reactive 实现响应式状态
    - 实现 upload、pause、resume、cancel 方法
    - 集成生命周期回调
    - _需求: 10.2, 10.5_
  - [x] 9.3 实现 useUploadList Composable
    - 实现响应式任务列表
    - 实现批量操作方法
    - _需求: 10.2, 10.5_
  - [x] 9.4 编写 Vue 适配层单元测试
    - 测试 Plugin 安装和清理
    - 测试 useUpload Composable 的状态管理
    - 测试 useUploadList Composable 的任务管理
    - _需求: 10.2, 10.3, 10.4, 10.5_

- [~] 10. Component 层 - React 组件
  - [x] 10.1 实现 UploadButton 组件
    - 创建 `@chunkflow/upload-component-react` 包
    - 实现文件选择功能
    - 实现文件验证（类型、大小）
    - _需求: 11.6_
  - [x] 10.2 实现 UploadProgress 组件
    - 显示进度条
    - 显示上传速度和剩余时间
    - _需求: 11.4_
  - [x] 10.3 实现 UploadList 组件
    - 显示任务列表
    - 集成 UploadProgress 组件
    - 实现暂停/恢复/删除操作
    - 支持自定义渲染
    - _需求: 11.1, 11.2, 11.4_
  - [x] 10.4 实现 UploadDropzone 组件
    - 实现拖拽上传功能
    - 实现文件验证
    - 实现拖拽状态视觉反馈
    - _需求: 11.5_
  - [~]\* 10.5 编写 React 组件单元测试
    - 测试 UploadButton 的文件选择和验证
    - 测试 UploadProgress 的进度显示
    - 测试 UploadList 的任务管理
    - 测试 UploadDropzone 的拖拽功能
    - _需求: 11.1, 11.2, 11.4, 11.5, 11.6_

- [~] 11. Component 层 - Vue 组件
  - [-] 11.1 实现 Vue 上传组件
    - 创建 `@chunkflow/upload-component-vue` 包
    - 实现 UploadButton.vue
    - 实现 UploadProgress.vue
    - 实现 UploadList.vue
    - 实现 UploadDropzone.vue
    - _需求: 11.1, 11.2, 11.4, 11.5, 11.6_
  - [~] 11.2 编写 Vue 组件单元测试
    - 测试各组件的功能
    - _需求: 11.1, 11.2, 11.4, 11.5, 11.6_

- [~] 12. Checkpoint - 前端功能完整性验证
  - 确保所有前端测试通过
  - 在 Playground 中测试完整的上传流程
  - 测试 React 和 Vue 组件的功能
  - 如有问题请向用户询问

- [~] 13. Server 层 - 存储适配器
  - [~] 13.1 定义存储适配器接口
    - 创建 `@chunkflow/upload-server` 包
    - 定义 StorageAdapter 接口
    - _需求: 12.6_
  - [~] 13.2 实现本地文件系统适配器
    - 实现 LocalStorageAdapter 类
    - 实现 saveChunk、getChunk、chunkExists 方法
    - 实现 chunksExist、getChunkStream 方法
    - 使用 Hash 前两位作为子目录
    - _需求: 12.6_
  - [~] 13.3 实现 OSS 存储适配器（可选）
    - 实现 OSSStorageAdapter 类
    - 集成 OSS SDK
    - _需求: 12.6_
  - [~] 13.4 编写存储适配器单元测试
    - 测试本地存储的 CRUD 操作
    - 测试分片存在性检查
    - 测试流式读取
    - _需求: 12.6_

- [~] 14. Server 层 - 数据库适配器
  - [~] 14.1 定义数据库适配器接口
    - 定义 DatabaseAdapter 接口
    - 定义 FileMetadata、ChunkEntity、FileChunkEntity 类型
    - _需求: 13.2_
  - [~] 14.2 实现 PostgreSQL 数据库适配器
    - 实现 PostgreSQLAdapter 类
    - 实现文件元数据的 CRUD 操作
    - 实现分片关联的管理
    - 实现事务支持
    - _需求: 13.2, 13.3_
  - [~] 14.3 编写数据库适配器单元测试
    - 测试文件元数据操作
    - 测试分片关联操作
    - 测试事务回滚
    - _需求: 13.2, 13.3_

- [~] 15. Server 层 - UploadService 实现
  - [~] 15.1 实现 createFile 方法
    - 生成 fileId 和 uploadToken
    - 协商分片大小
    - 保存文件元数据
    - _需求: 7.1, 12.1_
  - [~] 15.2 实现 verifyHash 方法
    - 验证 uploadToken
    - 检查文件 Hash 是否存在（秒传）
    - 检查分片 Hash 是否存在（部分秒传）
    - 返回已存在和缺失的分片列表
    - _需求: 7.2, 12.2_
  - [~] 15.3 实现 uploadChunk 方法
    - 验证 uploadToken
    - 验证分片 Hash
    - 保存分片到存储（去重）
    - 更新文件元数据
    - _需求: 7.3, 12.3, 18.2_
  - [~] 15.4 实现 mergeFile 方法
    - 验证 uploadToken
    - 验证所有分片已上传
    - 更新文件元数据（逻辑合并）
    - 生成文件访问 URL
    - _需求: 7.4, 12.4_
  - [~] 15.5 实现 getFileStream 方法
    - 根据 fileId 查找文件元数据
    - 按顺序读取分片
    - 创建流式管道输出
    - 支持 Range 请求
    - _需求: 13.4, 19.1, 19.2, 19.4_
  - [~] 15.6 编写 UploadService 单元测试
    - 测试创建文件流程
    - 测试 Hash 校验逻辑
    - 测试分片上传和去重
    - 测试逻辑合并
    - 测试文件流式输出
    - _需求: 12.1, 12.2, 12.3, 12.4, 13.4, 19.1, 19.2_
  - [~] 15.7 编写 UploadService 属性测试
    - **属性 14**: 分片去重存储
    - **属性 15**: 分片永久性
    - **属性 16**: 文件删除隔离
    - **属性 17**: 文件流式输出顺序
    - **属性 18**: Range 请求正确性
    - **验证需求**: 18.2, 18.4, 18.5, 19.1, 19.2, 19.4, 19.5

- [~] 16. 服务端应用 - Nest.js 实现
  - [~] 16.1 创建 Nest.js 项目
    - 创建 `apps/server` 目录
    - 初始化 Nest.js + Fastify 项目
    - 配置 PostgreSQL 连接
    - _需求: 13.1_
  - [~] 16.2 创建数据库模型
    - 创建 files 表
    - 创建 chunks 表
    - 创建 file_chunks 关联表
    - 创建索引
    - _需求: 13.2, 13.3_
  - [~] 16.3 实现 UploadController
    - 实现 POST /upload/create 接口
    - 实现 POST /upload/verify 接口
    - 实现 POST /upload/chunk 接口（支持 multipart）
    - 实现 POST /upload/merge 接口
    - 实现 GET /files/:fileId 接口（支持 Range）
    - _需求: 12.1, 12.2, 12.3, 12.4, 19.4_
  - [~] 16.4 实现错误处理中间件
    - 实现 Token 验证中间件
    - 实现全局异常过滤器
    - 实现错误响应格式化
    - _需求: 20.4_
  - [~] 16.5 配置 docker-compose
    - 创建 docker-compose.yml
    - 配置 PostgreSQL 服务
    - 配置 Nest.js 应用服务
    - _需求: 13.5_
  - [~] 16.6 编写服务端集成测试
    - 测试完整的上传流程
    - 测试秒传功能
    - 测试文件访问和 Range 请求
    - _需求: 12.1, 12.2, 12.3, 12.4, 19.4_

- [~] 17. Checkpoint - 服务端功能验证
  - 使用 docker-compose 启动服务端
  - 测试所有 API 接口
  - 测试分片去重和文件访问
  - 如有问题请向用户询问

- [~] 18. Playground 应用
  - [~] 18.1 创建 React Playground
    - 创建 `apps/playground` 目录
    - 使用 Vite 初始化 React 项目
    - 集成 @chunkflow/upload-client-react
    - 集成 @chunkflow/upload-component-react
    - _需求: 16.4_
  - [~] 18.2 实现演示页面
    - 实现文件上传演示
    - 实现断点续传演示
    - 实现秒传演示
    - 实现多文件上传演示
    - 显示上传统计信息
    - _需求: 16.4_
  - [~] 18.3 实现请求适配器
    - 实现基于 fetch 的 RequestAdapter
    - 连接到本地服务端
    - _需求: 8.3_

- [~] 19. 文档站点
  - [~] 19.1 创建 VitePress 项目
    - 创建 `apps/website` 目录
    - 初始化 VitePress
    - 配置主题和导航
    - _需求: 16.1, 16.5_
  - [~] 19.2 编写核心文档
    - 编写快速开始指南
    - 编写 API 文档（Protocol、Core、Client、Component、Server）
    - 编写配置指南
    - 编写最佳实践
    - _需求: 16.2, 16.3_
  - [~] 19.3 编写示例代码
    - 提供 React 使用示例
    - 提供 Vue 使用示例
    - 提供服务端集成示例
    - _需求: 16.3_
  - [~] 19.4 配置 GitHub Pages 部署
    - 创建 GitHub Actions 工作流
    - 配置自动部署
    - _需求: 16.5_

- [~] 20. 发布准备
  - [~] 20.1 配置 changeset
    - 安装和配置 @changesets/cli
    - 创建初始 changeset
    - _需求: 15.6_
  - [~] 20.2 编写 README 文件
    - 为每个包编写 README
    - 包含安装、使用、API 文档链接
    - _需求: 16.2_
  - [~] 20.3 配置 npm 发布
    - 配置 package.json 的发布字段
    - 配置 .npmignore
    - 测试本地发布
    - _需求: 14.5_
  - [~] 20.4 创建 GitHub Release
    - 编写 CHANGELOG
    - 创建 Git tag
    - 发布到 GitHub
    - _需求: 15.6_

- [~] 21. 最终验证
  - 运行所有测试（单元测试 + 属性测试）
  - 验证测试覆盖率达标
  - 在 Playground 中进行完整的功能测试
  - 验证文档站点可访问
  - 如有问题请向用户询问

## 注意事项

- 所有任务都是必需的，确保从一开始就有全面的测试覆盖
- 每个任务都引用了具体的需求编号，确保可追溯性
- Checkpoint 任务用于增量验证，确保每个阶段的质量
- 属性测试验证通用正确性属性，单元测试验证具体示例和边界情况
- 所有属性测试必须运行至少 100 次迭代
- 每个属性测试必须使用注释标记其对应的设计文档属性编号
