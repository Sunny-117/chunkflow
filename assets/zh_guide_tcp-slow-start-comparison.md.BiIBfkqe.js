import{_ as i,o as a,c as n,ag as t}from"./chunks/framework.C95KxxkN.js";const g=JSON.parse('{"title":"TCP 慢启动对比","description":"","frontmatter":{},"headers":[],"relativePath":"zh/guide/tcp-slow-start-comparison.md","filePath":"zh/guide/tcp-slow-start-comparison.md","lastUpdated":1769764082000}'),l={name:"zh/guide/tcp-slow-start-comparison.md"};function h(p,s,k,e,r,d){return a(),n("div",null,[...s[0]||(s[0]=[t(`<h1 id="tcp-慢启动对比" tabindex="-1">TCP 慢启动对比 <a class="header-anchor" href="#tcp-慢启动对比" aria-label="Permalink to &quot;TCP 慢启动对比&quot;">​</a></h1><p>本文档对比了 ChunkFlow 当前的分片大小调整算法与真实的 TCP 慢启动算法。</p><h2 id="当前实现" tabindex="-1">当前实现 <a class="header-anchor" href="#当前实现" aria-label="Permalink to &quot;当前实现&quot;">​</a></h2><p>ChunkFlow 的 <code>ChunkSizeAdjuster</code> 使用了简化的算法：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">adjust</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(uploadTimeMs: number): number {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">targetTime</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">minSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">maxSize</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.options;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 快速上传：分片大小翻倍</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uploadTimeMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> targetTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, maxSize);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 慢速上传：分片大小减半</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (uploadTimeMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> targetTime </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, minSize);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // 正常：保持当前大小</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="特点" tabindex="-1">特点 <a class="header-anchor" href="#特点" aria-label="Permalink to &quot;特点&quot;">​</a></h3><ul><li><strong>简单的二元决策</strong>：快速 → 翻倍，慢速 → 减半</li><li><strong>无状态机</strong>：始终使用相同的逻辑</li><li><strong>无阈值</strong>：不区分增长阶段</li><li><strong>激进</strong>：始终是指数级增长/减少</li></ul><h2 id="tcp-慢启动算法" tabindex="-1">TCP 慢启动算法 <a class="header-anchor" href="#tcp-慢启动算法" aria-label="Permalink to &quot;TCP 慢启动算法&quot;">​</a></h2><p>TCP 的拥塞控制有多个阶段：</p><h3 id="_1-慢启动阶段-slow-start" tabindex="-1">1. 慢启动阶段（Slow Start） <a class="header-anchor" href="#_1-慢启动阶段-slow-start" aria-label="Permalink to &quot;1. 慢启动阶段（Slow Start）&quot;">​</a></h3><ul><li><strong>初始窗口</strong>：从小窗口开始（通常是 1-10 MSS）</li><li><strong>增长</strong>：指数级 - 每个 RTT 翻倍</li><li><strong>触发条件</strong>：持续到达到 <code>ssthresh</code>（慢启动阈值）</li><li><strong>公式</strong>：每收到一个 ACK，<code>cwnd += MSS</code></li></ul><h3 id="_2-拥塞避免阶段-congestion-avoidance" tabindex="-1">2. 拥塞避免阶段（Congestion Avoidance） <a class="header-anchor" href="#_2-拥塞避免阶段-congestion-avoidance" aria-label="Permalink to &quot;2. 拥塞避免阶段（Congestion Avoidance）&quot;">​</a></h3><ul><li><strong>触发条件</strong>：当 <code>cwnd &gt;= ssthresh</code></li><li><strong>增长</strong>：线性 - 每个 RTT 增加 1 MSS</li><li><strong>公式</strong>：每个 ACK，<code>cwnd += MSS * MSS / cwnd</code></li><li><strong>目的</strong>：更保守的增长以避免拥塞</li></ul><h3 id="_3-快速恢复阶段-fast-recovery" tabindex="-1">3. 快速恢复阶段（Fast Recovery） <a class="header-anchor" href="#_3-快速恢复阶段-fast-recovery" aria-label="Permalink to &quot;3. 快速恢复阶段（Fast Recovery）&quot;">​</a></h3><ul><li><strong>触发条件</strong>：检测到丢包（3 个重复 ACK）</li><li><strong>动作</strong>： <ul><li>设置 <code>ssthresh = cwnd / 2</code></li><li>设置 <code>cwnd = ssthresh</code></li><li>进入拥塞避免阶段</li></ul></li><li><strong>目的</strong>：快速恢复而不完全重启</li></ul><h2 id="关键差异" tabindex="-1">关键差异 <a class="header-anchor" href="#关键差异" aria-label="Permalink to &quot;关键差异&quot;">​</a></h2><table tabindex="0"><thead><tr><th>方面</th><th>当前实现</th><th>TCP 慢启动</th></tr></thead><tbody><tr><td><strong>状态</strong></td><td>无（无状态）</td><td>3 个状态（慢启动、拥塞避免、快速恢复）</td></tr><tr><td><strong>阈值</strong></td><td>无</td><td><code>ssthresh</code> 决定阶段转换</td></tr><tr><td><strong>增长</strong></td><td>始终指数级（2x）</td><td>指数级 → 线性转换</td></tr><tr><td><strong>减少</strong></td><td>始终减半（0.5x）</td><td>减半并进入恢复状态</td></tr><tr><td><strong>复杂度</strong></td><td>简单</td><td>更复杂</td></tr><tr><td><strong>适应性</strong></td><td>二元（快/慢）</td><td>渐进式，具有状态感知</td></tr></tbody></table><h2 id="改进的类-tcp-实现" tabindex="-1">改进的类 TCP 实现 <a class="header-anchor" href="#改进的类-tcp-实现" aria-label="Permalink to &quot;改进的类 TCP 实现&quot;">​</a></h2><p>我们在 <code>chunk-size-adjuster-tcp.ts</code> 中创建了改进的实现：</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CongestionState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  SLOW_START</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;slow_start&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  CONGESTION_AVOIDANCE</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;congestion_avoidance&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  FAST_RECOVERY</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;fast_recovery&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> TCPChunkSizeAdjuster</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> currentSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> ssthresh</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 慢启动阈值</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> state</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> CongestionState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  adjust</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">uploadTimeMs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ratio</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uploadTimeMs </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> targetTime;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ratio </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 快速上传</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleFastUpload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (ratio </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1.5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">      // 慢速上传（拥塞）</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">      this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handleSlowUpload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleFastUpload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CongestionState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SLOW_START</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 指数级增长</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> newSize</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (newSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ssthresh) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ssthresh;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CongestionState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CONGESTION_AVOIDANCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">          this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> newSize;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CongestionState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CONGESTION_AVOIDANCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 线性增长（10% 增量）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> increment</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> increment;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CongestionState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FAST_RECOVERY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 退出恢复</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CongestionState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CONGESTION_AVOIDANCE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handleSlowUpload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 检测到拥塞</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ssthresh </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">floor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.currentSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.ssthresh;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.state </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CongestionState.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">FAST_RECOVERY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h2 id="类-tcp-方法的优势" tabindex="-1">类 TCP 方法的优势 <a class="header-anchor" href="#类-tcp-方法的优势" aria-label="Permalink to &quot;类 TCP 方法的优势&quot;">​</a></h2><h3 id="_1-渐进式增长" tabindex="-1">1. 渐进式增长 <a class="header-anchor" href="#_1-渐进式增长" aria-label="Permalink to &quot;1. 渐进式增长&quot;">​</a></h3><p>不是始终翻倍，算法从指数级增长过渡到线性增长：</p><ul><li><strong>早期阶段</strong>：快速指数级增长以快速找到最优大小</li><li><strong>后期阶段</strong>：保守的线性增长以避免过冲</li></ul><h3 id="_2-更好的拥塞处理" tabindex="-1">2. 更好的拥塞处理 <a class="header-anchor" href="#_2-更好的拥塞处理" aria-label="Permalink to &quot;2. 更好的拥塞处理&quot;">​</a></h3><p>当检测到拥塞时：</p><ul><li>基于当前性能设置阈值</li><li>减小大小但记住阈值</li><li>避免重复过冲</li></ul><h3 id="_3-状态感知" tabindex="-1">3. 状态感知 <a class="header-anchor" href="#_3-状态感知" aria-label="Permalink to &quot;3. 状态感知&quot;">​</a></h3><p>算法&quot;记住&quot;过去的性能：</p><ul><li>知道是否处于探索阶段（慢启动）</li><li>知道是否处于优化阶段（拥塞避免）</li><li>知道是否正在从拥塞中恢复</li></ul><h3 id="_4-更稳定" tabindex="-1">4. 更稳定 <a class="header-anchor" href="#_4-更稳定" aria-label="Permalink to &quot;4. 更稳定&quot;">​</a></h3><p>减少极端值之间的振荡：</p><ul><li>当前：1MB → 2MB → 4MB → 2MB → 4MB → 2MB（振荡）</li><li>类 TCP：1MB → 2MB → 4MB → 5MB → 5.5MB → 6MB（稳定增长）</li></ul><h2 id="性能对比" tabindex="-1">性能对比 <a class="header-anchor" href="#性能对比" aria-label="Permalink to &quot;性能对比&quot;">​</a></h2><h3 id="场景-1-快速网络" tabindex="-1">场景 1：快速网络 <a class="header-anchor" href="#场景-1-快速网络" aria-label="Permalink to &quot;场景 1：快速网络&quot;">​</a></h3><p><strong>当前实现</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1MB → 2MB → 4MB → 8MB → 10MB（最大）</span></span></code></pre></div><ul><li>4 步达到最大值</li><li>可能超过最优大小</li></ul><p><strong>类 TCP 实现</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1MB → 2MB → 4MB（ssthresh）→ 4.4MB → 4.8MB → 5.3MB</span></span></code></pre></div><ul><li>更渐进地接近最优大小</li><li>不太可能造成拥塞</li></ul><h3 id="场景-2-可变网络" tabindex="-1">场景 2：可变网络 <a class="header-anchor" href="#场景-2-可变网络" aria-label="Permalink to &quot;场景 2：可变网络&quot;">​</a></h3><p><strong>当前实现</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1MB → 2MB → 1MB → 2MB → 1MB（振荡）</span></span></code></pre></div><ul><li>不稳定，持续振荡</li></ul><p><strong>类 TCP 实现</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1MB → 2MB → 1MB（ssthresh）→ 1.1MB → 1.2MB（稳定）</span></span></code></pre></div><ul><li>找到稳定点</li><li>记住阈值</li></ul><h3 id="场景-3-网络降级" tabindex="-1">场景 3：网络降级 <a class="header-anchor" href="#场景-3-网络降级" aria-label="Permalink to &quot;场景 3：网络降级&quot;">​</a></h3><p><strong>当前实现</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>4MB → 2MB → 4MB → 2MB（无学习）</span></span></code></pre></div><ul><li>不从拥塞中学习</li></ul><p><strong>类 TCP 实现</strong>：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>4MB → 2MB（ssthresh）→ 2.2MB → 1MB（ssthresh）→ 1.1MB</span></span></code></pre></div><ul><li>基于经验调整阈值</li><li>拥塞后更保守</li></ul><h2 id="何时使用" tabindex="-1">何时使用 <a class="header-anchor" href="#何时使用" aria-label="Permalink to &quot;何时使用&quot;">​</a></h2><h3 id="当前实现-简单" tabindex="-1">当前实现（简单） <a class="header-anchor" href="#当前实现-简单" aria-label="Permalink to &quot;当前实现（简单）&quot;">​</a></h3><p><strong>优点</strong>：</p><ul><li>易于理解</li><li>低开销</li><li>在稳定网络上表现良好</li></ul><p><strong>缺点</strong>：</p><ul><li>在可变网络上可能振荡</li><li>不从过去的性能中学习</li><li>可能超过最优大小</li></ul><p><strong>最适合</strong>：</p><ul><li>稳定的网络条件</li><li>简单的用例</li><li>当简单性优先时</li></ul><h3 id="类-tcp-实现" tabindex="-1">类 TCP 实现 <a class="header-anchor" href="#类-tcp-实现" aria-label="Permalink to &quot;类 TCP 实现&quot;">​</a></h3><p><strong>优点</strong>：</p><ul><li>在可变网络上更稳定</li><li>从过去的性能中学习</li><li>更好的拥塞处理</li><li>更接近经过验证的 TCP 算法</li></ul><p><strong>缺点</strong>：</p><ul><li>更复杂</li><li>略高的开销</li><li>需要调整 ssthresh</li></ul><p><strong>最适合</strong>：</p><ul><li>可变的网络条件</li><li>生产环境</li><li>当稳定性至关重要时</li><li>大文件上传</li></ul><h2 id="建议" tabindex="-1">建议 <a class="header-anchor" href="#建议" aria-label="Permalink to &quot;建议&quot;">​</a></h2><p>对于 ChunkFlow，我们建议：</p><ol><li><strong>保持当前实现作为默认</strong>，以保持简单性</li><li><strong>提供类 TCP 实现作为选项</strong>，供高级用户使用</li><li><strong>添加配置</strong>以在算法之间选择：</li></ol><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> manager</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UploadManager</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  requestAdapter: adapter,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chunkSizeStrategy: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;simple&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 或 &#39;tcp-like&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  chunkSizeOptions: {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    initialSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    minSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">256</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    maxSize: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 类 TCP 特定选项</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    initialSsthresh: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h2 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h2><p>虽然 ChunkFlow 的当前实现<strong>受 TCP 慢启动启发</strong>，但它是一个<strong>简化版本</strong>，捕获了核心思想（快速时指数级增长，慢速时减少），但缺少完整 TCP 算法的复杂性。</p><p>类 TCP 实现以增加复杂性为代价提供了更好的稳定性和适应性。两者都有各自的用途，取决于使用场景。</p><h2 id="另请参阅" tabindex="-1">另请参阅 <a class="header-anchor" href="#另请参阅" aria-label="Permalink to &quot;另请参阅&quot;">​</a></h2><ul><li><a href="/chunkflow/zh/guide/dynamic-chunking">动态分片指南</a></li><li><a href="/chunkflow/zh/guide/performance">性能优化</a></li><li><a href="https://tools.ietf.org/html/rfc5681" target="_blank" rel="noreferrer">TCP 拥塞控制（RFC 5681）</a></li></ul>`,79)])])}const o=i(l,[["render",h]]);export{g as __pageData,o as default};
